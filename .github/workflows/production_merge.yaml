name: Zombi CI Actions Production (Merge)

on:
  pull_request:
    types: [ closed ]
    branches:
      - master

env:
  ZOMBI_ENV: ${{ secrets.PRODUCTIONS_SECRETS }}
  CI: true
  EXCHANGE_OMS_ID: 1
  ISOLATE: true

jobs:
  merge_job:
    # this job will only run if the PR has been merged
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    services:
      # mysql:
      #   image: mysql:5.7
      #   env:
      #     MYSQL_ROOT_PASSWORD: root
      #   ports:
      #   - 3306:3306
      #   options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=10
      postgres:
        image: postgres
        env:
          POSTGRES_PASSWORD: postgres
        ports:
        - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis
        ports:
        - 6379:6379
        options: --entrypoint redis-server
    steps:
      - name: Show PR number
        run: |
          echo PR #${{ github.event.number }} has been merged
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: 'master'
      - name: Creates the environment file
        run: mkdir .env ; printf "%s" "$ZOMBI_ENV" > ".env/local"
      - name: Install dependencies
        run: npm run i
      - name: Setup database schema
        run: . .env/local ; npm run schema
      - name: Start API server
        run: npm run gateway &
      - name: Wait for server to start
        run: sleep 6s
      - name: Server API smoke test
        run: |
          curl -s -d '{"mod":"system/public", "fun":"hash", "args": "a cow with no name"}' -H "Content-Type: application/json" -X POST http://localhost:8000/server
      - name: Run unit tests
        run: . .env/local ; npm run test:unit
      - name: Run API tests
        run: . .env/local ; npm run test:api
  close_job:
    # this job will only run if the PR has been closed without being merged
    if: github.event.pull_request.merged == false
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo PR #${{ github.event.number }} has been closed without being merged

